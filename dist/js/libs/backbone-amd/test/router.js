!function(){function t(t,e,o){a=e,n=o}var e=null,o=null,a=null,n=[],r=function(t){this.replace(t)};_.extend(r.prototype,{replace:function(t){_.extend(this,_.pick($("<a></a>",{href:t})[0],"href","hash","host","search","fragment","pathname","protocol")),/^\//.test(this.pathname)||(this.pathname="/"+this.pathname)},toString:function(){return this.href}}),module("Backbone.Router",{setup:function(){o=new r("http://example.com"),Backbone.history=_.extend(new Backbone.History,{location:o}),e=new s({testing:101}),Backbone.history.interval=9,Backbone.history.start({pushState:!1}),a=null,n=[],Backbone.history.on("route",t)},teardown:function(){Backbone.history.stop(),Backbone.history.off("route",t)}});var c={value:"unset",routingFunction:function(t){this.value=t}};_.bindAll(c);var s=Backbone.Router.extend({count:0,routes:{noCallback:"noCallback",counter:"counter","search/:query":"search","search/:query/p:page":"search","charñ":"charUTF","char%C3%B1":"charEscaped",contacts:"contacts","contacts/new":"newContact","contacts/:id":"loadContact","route-event/:arg":"routeEvent","optional(/:item)":"optionalItem","named/optional/(y:z)":"namedOptional","splat/*args/end":"splat",":repo/compare/*from...*to":"github","decode/:named/*splat":"decode","*first/complex-*part/*rest":"complex",":entity?*args":"query","function/:value":c.routingFunction,"*anything":"anything"},initialize:function(t){this.testing=t.testing,this.route("implicit","implicit")},counter:function(){this.count++},implicit:function(){this.count++},search:function(t,e){this.query=t,this.page=e},charUTF:function(){this.charType="UTF"},charEscaped:function(){this.charType="escaped"},contacts:function(){this.contact="index"},newContact:function(){this.contact="new"},loadContact:function(){this.contact="load"},optionalItem:function(t){this.arg=void 0!=t?t:null},splat:function(t){this.args=t},github:function(t,e,o){this.repo=t,this.from=e,this.to=o},complex:function(t,e,o){this.first=t,this.part=e,this.rest=o},query:function(t,e){this.entity=t,this.queryArgs=e},anything:function(t){this.anything=t},namedOptional:function(t){this.z=t},decode:function(t,e){this.named=t,this.path=e},routeEvent:function(t){}});test("initialize",1,function(){equal(e.testing,101)}),test("routes (simple)",4,function(){o.replace("http://example.com#search/news"),Backbone.history.checkUrl(),equal(e.query,"news"),equal(e.page,void 0),equal(a,"search"),equal(n[0],"news")}),test("routes (simple, but unicode)",4,function(){o.replace("http://example.com#search/тест"),Backbone.history.checkUrl(),equal(e.query,"тест"),equal(e.page,void 0),equal(a,"search"),equal(n[0],"тест")}),test("routes (two part)",2,function(){o.replace("http://example.com#search/nyc/p10"),Backbone.history.checkUrl(),equal(e.query,"nyc"),equal(e.page,"10")}),test("routes via navigate",2,function(){Backbone.history.navigate("search/manhattan/p20",{trigger:!0}),equal(e.query,"manhattan"),equal(e.page,"20")}),test("routes via navigate for backwards-compatibility",2,function(){Backbone.history.navigate("search/manhattan/p20",!0),equal(e.query,"manhattan"),equal(e.page,"20")}),test("reports matched route via nagivate",1,function(){ok(Backbone.history.navigate("search/manhattan/p20",!0))}),test("route precedence via navigate",6,function(){_.each([{trigger:!0},!0],function(t){Backbone.history.navigate("contacts",t),equal(e.contact,"index"),Backbone.history.navigate("contacts/new",t),equal(e.contact,"new"),Backbone.history.navigate("contacts/foo",t),equal(e.contact,"load")})}),test("loadUrl is not called for identical routes.",0,function(){Backbone.history.loadUrl=function(){ok(!1)},o.replace("http://example.com#route"),Backbone.history.navigate("route"),Backbone.history.navigate("/route"),Backbone.history.navigate("/route")}),test("use implicit callback if none provided",1,function(){e.count=0,e.navigate("implicit",{trigger:!0}),equal(e.count,1)}),test("routes via navigate with {replace: true}",1,function(){o.replace("http://example.com#start_here"),Backbone.history.checkUrl(),o.replace=function(t){strictEqual(t,new r("http://example.com#end_here").href)},Backbone.history.navigate("end_here",{replace:!0})}),test("routes (splats)",1,function(){o.replace("http://example.com#splat/long-list/of/splatted_99args/end"),Backbone.history.checkUrl(),equal(e.args,"long-list/of/splatted_99args")}),test("routes (github)",3,function(){o.replace("http://example.com#backbone/compare/1.0...braddunbar:with/slash"),Backbone.history.checkUrl(),equal(e.repo,"backbone"),equal(e.from,"1.0"),equal(e.to,"braddunbar:with/slash")}),test("routes (optional)",2,function(){o.replace("http://example.com#optional"),Backbone.history.checkUrl(),ok(!e.arg),o.replace("http://example.com#optional/thing"),Backbone.history.checkUrl(),equal(e.arg,"thing")}),test("routes (complex)",3,function(){o.replace("http://example.com#one/two/three/complex-part/four/five/six/seven"),Backbone.history.checkUrl(),equal(e.first,"one/two/three"),equal(e.part,"part"),equal(e.rest,"four/five/six/seven")}),test("routes (query)",5,function(){o.replace("http://example.com#mandel?a=b&c=d"),Backbone.history.checkUrl(),equal(e.entity,"mandel"),equal(e.queryArgs,"a=b&c=d"),equal(a,"query"),equal(n[0],"mandel"),equal(n[1],"a=b&c=d")}),test("routes (anything)",1,function(){o.replace("http://example.com#doesnt-match-a-route"),Backbone.history.checkUrl(),equal(e.anything,"doesnt-match-a-route")}),test("routes (function)",3,function(){e.on("route",function(t){ok(""===t)}),equal(c.value,"unset"),o.replace("http://example.com#function/set"),Backbone.history.checkUrl(),equal(c.value,"set")}),test("Decode named parameters, not splats.",2,function(){o.replace("http://example.com#decode/a%2Fb/c%2Fd/e"),Backbone.history.checkUrl(),strictEqual(e.named,"a/b"),strictEqual(e.path,"c/d/e")}),test("fires event when router doesn't have callback on it",1,function(){e.on("route:noCallback",function(){ok(!0)}),o.replace("http://example.com#noCallback"),Backbone.history.checkUrl()}),test("#933, #908 - leading slash",2,function(){o.replace("http://example.com/root/foo"),Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.start({root:"/root",hashChange:!1,silent:!0}),strictEqual(Backbone.history.getFragment(),"foo"),Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.start({root:"/root/",hashChange:!1,silent:!0}),strictEqual(Backbone.history.getFragment(),"foo")}),test("#1003 - History is started before navigate is called",1,function(){Backbone.history.stop(),Backbone.history.navigate=function(){ok(Backbone.History.started)},Backbone.history.start(),Backbone.history.iframe||ok(!0)}),test("#967 - Route callback gets passed encoded values.",3,function(){var t="has%2Fslash/complex-has%23hash/has%20space";Backbone.history.navigate(t,{trigger:!0}),strictEqual(e.first,"has/slash"),strictEqual(e.part,"has#hash"),strictEqual(e.rest,"has space")}),test("correctly handles URLs with % (#868)",3,function(){o.replace("http://example.com#search/fat%3A1.5%25"),Backbone.history.checkUrl(),o.replace("http://example.com#search/fat"),Backbone.history.checkUrl(),equal(e.query,"fat"),equal(e.page,void 0),equal(a,"search")}),test("#2666 - Hashes with UTF8 in them.",2,function(){Backbone.history.navigate("charñ",{trigger:!0}),equal(e.charType,"UTF"),Backbone.history.navigate("char%C3%B1",{trigger:!0}),equal(e.charType,"escaped")}),test("#1185 - Use pathname when hashChange is not wanted.",1,function(){Backbone.history.stop(),o.replace("http://example.com/path/name#hash"),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.start({hashChange:!1});var t=Backbone.history.getFragment();strictEqual(t,o.pathname.replace(/^\//,""))}),test("#1206 - Strip leading slash before location.assign.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root/"),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.start({hashChange:!1,root:"/root/"}),o.assign=function(t){strictEqual(t,"/root/fragment")},Backbone.history.navigate("/fragment")}),test("#1387 - Root fragment without trailing slash.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root"),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.start({hashChange:!1,root:"/root/",silent:!0}),strictEqual(Backbone.history.getFragment(),"")}),test("#1366 - History does not prepend root to fragment.",2,function(){Backbone.history.stop(),o.replace("http://example.com/root/"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/root/x")}}}),Backbone.history.start({root:"/root/",pushState:!0,hashChange:!1}),Backbone.history.navigate("x"),strictEqual(Backbone.history.fragment,"x")}),test("Normalize root.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/root/fragment")}}}),Backbone.history.start({pushState:!0,root:"/root",hashChange:!1}),Backbone.history.navigate("fragment")}),test("Normalize root.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root#fragment"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){},replaceState:function(t,e,o){strictEqual(o,"/root/fragment")}}}),Backbone.history.start({pushState:!0,root:"/root"})}),test("Normalize root.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root"),Backbone.history=_.extend(new Backbone.History,{location:o}),Backbone.history.loadUrl=function(){ok(!0)},Backbone.history.start({pushState:!0,root:"/root"})}),test("Normalize root - leading slash.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(){}}}),Backbone.history.start({root:"root"}),strictEqual(Backbone.history.root,"/root/")}),test("Transition from hashChange to pushState.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root#x/y"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(t,e,o){strictEqual(o,"/root/x/y")}}}),Backbone.history.start({root:"root",pushState:!0})}),test("#1619: Router: Normalize empty root",1,function(){Backbone.history.stop(),o.replace("http://example.com/"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(){}}}),Backbone.history.start({root:""}),strictEqual(Backbone.history.root,"/")}),test("#1619: Router: nagivate with empty root",1,function(){Backbone.history.stop(),o.replace("http://example.com/"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/fragment")}}}),Backbone.history.start({pushState:!0,root:"",hashChange:!1}),Backbone.history.navigate("fragment")}),test("Transition from pushState to hashChange.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root/x/y?a=b"),o.replace=function(t){strictEqual(t,"/root/?a=b#x/y")},Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:null,replaceState:null}}),Backbone.history.start({root:"root",pushState:!0})}),test("#1695 - hashChange to pushState with search.",1,function(){Backbone.history.stop(),o.replace("http://example.com/root?a=b#x/y"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(t,e,o){strictEqual(o,"/root/x/y?a=b")}}}),Backbone.history.start({root:"root",pushState:!0})}),test("#1746 - Router allows empty route.",1,function(){var t=Backbone.Router.extend({routes:{"":"empty"},empty:function(){},route:function(t){strictEqual(t,"")}});new t}),test("#1794 - Trailing space in fragments.",1,function(){var t=new Backbone.History;strictEqual(t.getFragment("fragment   "),"fragment")}),test("#1820 - Leading slash and trailing space.",1,function(){var t=new Backbone.History;strictEqual(t.getFragment("/fragment "),"fragment")}),test("#1980 - Optional parameters.",2,function(){o.replace("http://example.com#named/optional/y"),Backbone.history.checkUrl(),strictEqual(e.z,void 0),o.replace("http://example.com#named/optional/y123"),Backbone.history.checkUrl(),strictEqual(e.z,"123")}),test("#2062 - Trigger 'route' event on router instance.",2,function(){e.on("route",function(t,e){strictEqual(t,"routeEvent"),deepEqual(e,["x"])}),o.replace("http://example.com#route-event/x"),Backbone.history.checkUrl()}),test("#2255 - Extend routes by making routes a function.",1,function(){var t=Backbone.Router.extend({routes:function(){return{home:"root",index:"index.html"}}}),e=t.extend({routes:function(){var t=e.__super__.routes;return _.extend(t(),{show:"show",search:"search"})}}),o=new e;deepEqual({home:"root",index:"index.html",show:"show",search:"search"},o.routes)}),test("#2538 - hashChange to pushState only if both requested.",0,function(){Backbone.history.stop(),o.replace("http://example.com/root?a=b#x/y"),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(){ok(!1)}}}),Backbone.history.start({root:"root",pushState:!0,hashChange:!1})}),test("No hash fallback.",0,function(){Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(){},replaceState:function(){}}});var t=Backbone.Router.extend({routes:{hash:function(){ok(!1)}}});new t;o.replace("http://example.com/"),Backbone.history.start({pushState:!0,hashChange:!1}),o.replace("http://example.com/nomatch#hash"),Backbone.history.checkUrl()}),test("#2656 - No trailing slash on root.",1,function(){Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/root")}}}),o.replace("http://example.com/root/path"),Backbone.history.start({pushState:!0,root:"root"}),Backbone.history.navigate("")}),test("#2656 - No trailing slash on root.",1,function(){Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/")}}}),o.replace("http://example.com/path"),Backbone.history.start({pushState:!0}),Backbone.history.navigate("")}),test("#2765 - Fragment matching sans query/hash.",2,function(){Backbone.history.stop(),Backbone.history=_.extend(new Backbone.History,{location:o,history:{pushState:function(t,e,o){strictEqual(o,"/path?query#hash")}}});var t=Backbone.Router.extend({routes:{path:function(){ok(!0)}}});new t;o.replace("http://example.com/"),Backbone.history.start({pushState:!0}),Backbone.history.navigate("path?query#hash",!0)})}();